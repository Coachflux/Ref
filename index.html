<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Mining & Referral App</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta property="og:title" content="Earn by Mining and Referring!">
  <meta property="og:description" content="Earn daily by mining and referring friends. Get bonuses instantly!">
  <meta property="og:image" content="https://yourdomain.com/referral.png">
  <style>
    body { background: #f9fafb; font-family: 'Segoe UI', Arial, sans-serif; color: #222; margin: 0;}
    .container { max-width: 430px; margin: 40px auto; background: #fff; border-radius: 14px; box-shadow: 0 2px 16px #0001; padding: 32px 26px 16px;}
    h1, h2 { text-align: center; color: #1366d6; }
    .page { display: none;}
    .show { display: block !important;}
    .input-group { margin-bottom: 18px; }
    input[type="text"], input[type="password"] {
      width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px;
    }
    button { padding: 9px 18px; font-size: 16px; border: none; border-radius: 6px; background: #1366d6; color: #fff; margin-top: 8px;}
    #rank, #rankProgress { cursor: pointer; }
    #rankProgress { display: block; background: #e4e7ec; border-radius: 4px; height: 14px; margin: 8px 0;}
    #rankBar { background: #1366d6; height: 100%; border-radius: 4px 0 0 4px;}
    #rankDetails { background: #eef6ff; color: #1366d6; padding: 7px 10px; border-radius: 5px; margin: 5px 0; display: none;}
    .center { text-align: center;}
    .ref-wrap { background: #f5fbff; border-radius: 8px; padding: 12px; margin-top: 12px;}
    .stats-row { display: flex; justify-content: space-between; margin-bottom: 7px;}
    .flex-buttons { display: flex; gap: 8px; justify-content: flex-start;}
    .missed { color: #d32f2f;}
    #calendarPopup { background: #fff; border: 1px solid #ccc; padding: 8px 10px; border-radius: 8px; position: absolute; left: 50%; transform: translateX(-50%); z-index: 10; width: 250px; top: 200px; display: none; max-height: 180px; overflow-y: auto;}
    #miningSound { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Mine & Earn with Referrals</h1>
    <div class="page" id="login">
      <h2>Login</h2>
      <div class="input-group"><input type="text" id="loginUsername" placeholder="Username" autocomplete="username"></div>
      <div class="input-group"><input type="password" id="loginPassword" placeholder="Password" autocomplete="current-password"></div>
      <button onclick="loginUser()">Log In</button>
      <p style="text-align:right; font-size:15px;">Or <a href="#" onclick="showPage('register')">Register</a></p>
    </div>
    <div class="page" id="register">
      <h2>Register</h2>
      <div class="input-group"><input type="text" id="username" placeholder="Username"></div>
      <div class="input-group"><input type="password" id="password" placeholder="Password"></div>
      <div class="input-group"><input type="text" id="inviterCode" placeholder="Referral Code (optional)"></div>
      <button onclick="registerUser()">Register</button>
      <p style="text-align:right; font-size:15px;">Have an account? <a href="#" onclick="showPage('login')">Log in</a></p>
    </div>
    <div class="page" id="referral">
      <div class="center" style="margin-bottom:7px;">
        <b id="displayUsername"></b>
        <button onclick="logout()" style="float:right;background:#f44336;margin:-6px 0 0 0;">Logout</button>
      </div>
      <div style="font-size:19px; font-weight:600;">Balance: <span id="balance">$0.00</span></div>
      <div class="stats-row">
        <span>Today Mined: <span id="mined">+0.00000</span></span>
        <span id="countdown">00:00:00</span>
      </div>
      <div class="flex-buttons">
        <button onclick="startMining()">Start Mining</button>
        <button onclick="toggleCalendar()">Calendar</button>
      </div>
      <div id="calendarPopup"></div>
      <div id="rank" style="margin:14px 0 0 0; font-weight: 600;">Rank: -</div>
      <div id="rankProgress"><div id="rankBar" style="width:0%"></div></div>
      <div id="rankDetails"></div>
      <div class="ref-wrap">
        <div>Your Referral Code:<br><b id="referralCode"></b></div>
        <div>Your Referral Link:<br>
          <span id="referralLink"></span>
          <button onclick="copyText('referralLink')">Copy</button>
          <button onclick="shareReferral()">Share</button>
        </div>
        <div>People referred: <span id="referralCount">0</span></div>
        <div>Profit from referrals: $<span id="referralProfit">0.00</span></div>
        <div style="margin-top:7px;">
          <small>Share your link &amp; earn <b>$0.3 both ways</b> when a friend signs up!</small>
        </div>
      </div>
    </div>
    <audio id="miningSound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_115b9d4f5b.mp3"></audio>
  </div>
  <script>
    function showPage(page) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('show'));
      document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
      document.getElementById(page).classList.remove('hidden');
      document.getElementById(page).classList.add('show');
      if (page === 'referral') displayReferralInfo();
    }
    function generateReferralCode(username) {
      return username + Math.floor(Math.random() * 10000);
    }
    function registerUser() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value.trim();
      const inviterCode = document.getElementById('inviterCode').value.trim();
      if (!username || !password) return alert("Please fill all required fields.");
      if (localStorage.getItem(`user_${username}`)) return alert("Username already exists.");
      
      const newUser = {
        username,
        password,
        referralCode: generateReferralCode(username),
        invited: 0,
        referralProfit: 0,
        balance: 0
      };

      // Credit invitee with $0.3 if valid inviter code is provided
      let inviterFound = false;
      if (inviterCode) {
        Object.keys(localStorage).forEach(key => {
          if (key.startsWith('user_')) {
            const inviter = JSON.parse(localStorage.getItem(key));
            if (inviter.referralCode === inviterCode) {
              inviter.invited = (inviter.invited || 0) + 1;
              inviter.referralProfit = (inviter.referralProfit || 0) + 0.3;
              inviter.balance = (parseFloat(inviter.balance) || 0) + 0.3;
              localStorage.setItem(key, JSON.stringify(inviter));
              newUser.balance = 0.3; // Credit invitee
              newUser.referralProfit = 0.3; // Track invitee's referral profit
              inviterFound = true;
            }
          }
        });
        if (!inviterFound) {
          alert("Invalid referral code. No bonus applied.");
        }
      }

      localStorage.setItem(`user_${username}`, JSON.stringify(newUser));
      localStorage.setItem('currentUser', username);
      localStorage.setItem(`${username}_balance`, newUser.balance.toFixed(6));
      showPage('referral');
    }
    function loginUser() {
      const username = document.getElementById('loginUsername').value.trim();
      const password = document.getElementById('loginPassword').value.trim();
      if (!username || !password) return alert("Please enter your credentials.");
      const userData = JSON.parse(localStorage.getItem(`user_${username}`));
      if (!userData || userData.password !== password) {
        return alert("Invalid username or password.");
      }
      localStorage.setItem('currentUser', username);
      showPage('referral');
    }
    function displayReferralInfo() {
      const username = localStorage.getItem('currentUser');
      if (!username) return showPage('login');
      const userData = JSON.parse(localStorage.getItem(`user_${username}`)) || {};
      document.getElementById('displayUsername').innerText = userData.username || '';
      document.getElementById('referralCode').innerText = userData.referralCode || '';
      document.getElementById('referralLink').innerText = `${location.origin}${location.pathname}?ref=${userData.referralCode || ''}`;
      document.getElementById('referralCount').innerText = userData.invited || 0;
      document.getElementById('referralProfit').innerText = (userData.referralProfit || 0).toFixed(2);
      const balance = parseFloat(userData.balance) || 0;
      document.getElementById('balance').textContent = '$' + balance.toFixed(2);
      localStorage.setItem(`${username}_balance`, balance.toFixed(6));
      localStorage.setItem('balance', balance.toFixed(6));
    }
    function logout() {
      localStorage.removeItem('currentUser');
      showPage('login');
    }
    function copyText(id) {
      const text = document.getElementById(id).innerText;
      navigator.clipboard.writeText(text).then(() => { alert("Copied!"); });
    }
    function shareReferral() {
      const username = localStorage.getItem('currentUser');
      const userData = JSON.parse(localStorage.getItem(`user_${username}`));
      const url = `${location.origin}${location.pathname}?ref=${userData.referralCode}`;
      const shareData = {
        title: `${userData.username}'s Referral`,
        text: `${userData.username} invites you! Earn $0.3 for joining with their link!`,
        url: url
      };
      if (navigator.share) {
        navigator.share(shareData).catch(() => { alert('Share canceled or not supported.'); });
      } else {
        copyText('referralLink');
      }
    }
    // Storage event listener for real-time updates
    window.addEventListener('storage', (e) => {
      if (e.key && e.key.startsWith('user_') && localStorage.getItem('currentUser')) {
        displayReferralInfo();
      }
    });
    (function(){
      const DURATION = 86400000, RATE = 0.00002;
      let timer = null;
      const balanceEl = document.getElementById('balance'),
            countdownEl = document.getElementById('countdown'),
            minedEl = document.getElementById('mined'),
            rankEl = document.getElementById('rank'),
            rankBar = document.getElementById('rankBar'),
            rankDetails = document.getElementById('rankDetails'),
            calendar = document.getElementById('calendarPopup'),
            sound = document.getElementById('miningSound');
      function get(key) { 
        const currentUser = localStorage.getItem('currentUser') || '';
        return localStorage.getItem(currentUser ? key.replace('{user}', currentUser) : key); 
      }
      function set(key, val) { 
        const currentUser = localStorage.getItem('currentUser') || '';
        localStorage.setItem(currentUser ? key.replace('{user}', currentUser) : key, val); 
      }
      function today() { return new Date().toISOString().split('T')[0]; }
      function getUser() {
        const un = localStorage.getItem('currentUser');
        return un ? JSON.parse(localStorage.getItem(`user_${un}`)) : null;
      }
      function saveUser(u) {
        if (u && u.username) localStorage.setItem(`user_${u.username}`, JSON.stringify(u));
      }
      function getBalance() {
        const user = getUser() || { balance: 0 };
        return parseFloat(user.balance) || 0;
      }
      function setBalance(val) {
        const user = getUser();
        if (user) {
          user.balance = parseFloat(val.toFixed(6));
          saveUser(user);
        }
        const currentUser = localStorage.getItem('currentUser') || '';
        localStorage.setItem(`${currentUser}_balance`, val.toFixed(6));
        localStorage.setItem('balance', val.toFixed(6));
        if (balanceEl) balanceEl.textContent = '$' + val.toFixed(2);
      }
      function getDays() { 
        const currentUser = localStorage.getItem('currentUser') || '';
        return JSON.parse(localStorage.getItem(`days_${currentUser}`) || '[]'); 
      }
      function saveDay() {
        const currentUser = localStorage.getItem('currentUser');
        if (!currentUser) return;
        const key = `days_${currentUser}`;
        const d = getDays(), t = today();
        if (!d.includes(t)) { 
          d.push(t); 
          localStorage.setItem(key, JSON.stringify(d)); 
        }
      }
      function updateRankUI() {
        const days = getDays().length;
        let name = 'Starter', pct = days / 30 * 100, next = 'Pioneer', rem = 30 - days;
        if (days >= 90) { name = 'Supreme'; pct = 100; next = null; }
        else if (days >= 60) { name = 'Elite'; pct = (days - 60) / 30 * 100; rem = 90 - days; next = 'Supreme'; }
        else if (days >= 30) { name = 'Pioneer'; pct = (days - 30) / 30 * 100; rem = 60 - days; next = 'Elite'; }
        rankEl.textContent = 'Rank: ' + name;
        rankBar.style.width = pct + '%';
        rankDetails.innerHTML = next
          ? `Progress: ${days} days<br>Next: ${next} in ${rem} days`
          : `🎉 Top rank! (${days} days)`;
      }
      function applyBonus() {
        const arr = getDays(), dates = [];
        let bonus = 0, streak = 0;
        for (let i = 0; i < 7; i++) {
          const d = new Date(); d.setDate(d.getDate() - i);
          dates.push(d.toISOString().split('T')[0]);
        }
        dates.forEach(d => {
          if (arr.includes(d)) {
            streak++;
            if (streak === 2) bonus += 0.05;
            if (streak === 5) bonus += 0.5;
          } else streak = 0;
        });
        if (bonus) {
          alert('🎉 Bonus earned!');
          setBalance(getBalance() + bonus);
          const user = getUser();
          if (user) {
            user.balance = getBalance();
            saveUser(user);
          }
        }
      }
      function tick() {
        const currentUser = localStorage.getItem('currentUser') || '';
        const start = parseInt(get('startTime'));
        const base = parseFloat(get('baseBalance') || '0');
        const now = Date.now();
        const elapsed = now - start;
        const remain = Math.max(0, DURATION - elapsed);
        if (remain <= 0) {
          clearInterval(timer);
          countdownEl.textContent = '00:00:00';
          minedEl.textContent = '+1.72800';
          const finalBalance = base + 1.728;
          setBalance(finalBalance);
          localStorage.removeItem(`startTime_${currentUser}`);
          localStorage.removeItem(`baseBalance_${currentUser}`);
          saveDay();
          applyBonus();
          updateRankUI();
          return;
        }
        const earned = (elapsed / 1000) * RATE;
        const currentBalance = base + earned;
        minedEl.textContent = '+' + earned.toFixed(5);
        setBalance(currentBalance);
        const hours = String(Math.floor(remain / (3600 * 1000))).padStart(2, '0');
        const mins = String(Math.floor((remain % (3600 * 1000)) / 60000)).padStart(2, '0');
        const secs = String(Math.floor((remain % 60000) / 1000)).padStart(2, '0');
        countdownEl.textContent = `${hours}:${mins}:${secs}`;
      }
      window.startMining = function() {
        const currentUser = localStorage.getItem('currentUser');
        if (!currentUser || get('startTime')) return;
        sound.play();
        const now = Date.now();
        const currentBalance = getBalance();
        set('startTime', now);
        set('baseBalance', currentBalance);
        timer = setInterval(tick, 1000);
      };
      window.toggleCalendar = function() {
        const arr = getDays(), t = today();
        let html = '';
        for (let i = 0; i < 30; i++) {
          const d = new Date(); d.setDate(d.getDate() - i);
          const ds = d.toISOString().split('T')[0];
          html += `<div>${ds} ${arr.includes(ds) ? '✅' : '<span class="missed">❌</span>'}</div>`;
        }
        calendar.innerHTML = html;
        calendar.style.display = calendar.style.display === 'block' ? 'none' : 'block';
      };
      rankEl.addEventListener('click', () => {
        rankDetails.style.display = rankDetails.style.display === 'block' ? 'none' : 'block';
      });
      window.onload = () => {
        const refCode = new URLSearchParams(window.location.search).get('ref');
        if (refCode) {
          localStorage.setItem('incomingRefCode', refCode);
          const inviterInput = document.getElementById('inviterCode');
          if (inviterInput) inviterInput.value = refCode;
        }
        const user = localStorage.getItem('currentUser');
        if (user) {
          showPage('referral');
        } else {
          showPage('login');
        }
        updateRankUI();
        const bal = getBalance();
        setBalance(bal);
        const currentUser = localStorage.getItem('currentUser') || '';
        if (get(`startTime_${currentUser}`)) {
          timer = setInterval(tick, 1000);
          sound.play();
        }
      };
    })();
  </script>
</body>
</html>
