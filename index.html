<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>USDT Miner — Referral Dashboard</title>
<meta name="description" content="Start mining and earn USDT rewards by inviting friends.">
<meta property="og:title" content="Earn USDT Daily with USDT Miner">
<meta property="og:description" content="Start mining and earn USDT rewards by inviting friends.">
<meta property="og:image" content="https://via.placeholder.com/1200x630.png?text=USDT+Miner+Placeholder">
<style>
:root{--bg:#041d18;--card:#f6fff8;--accent1:#00d996;--accent2:#008f63;--muted:#6b8a81;--danger:#7a1f1f}
*{box-sizing:border-box}
body{font-family:Inter,system-ui,-apple-system,'Segoe UI',Roboto,Arial;margin:0;min-height:100vh;background:linear-gradient(180deg,var(--bg),#01312b);display:flex;align-items:center;justify-content:center;padding:24px;color:#052828}
.app{width:100%;max-width:980px;background:var(--card);border-radius:14px;padding:18px;box-shadow:0 18px 50px rgba(0,0,0,0.45)}
header{display:flex;gap:14px;align-items:center;justify-content:center;margin-bottom:12px}
header img{width:64px;height:64px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.15)}
header h1{margin:0;color:#04312a}
.muted{color:var(--muted)}
.grid{display:flex;gap:18px;flex-wrap:wrap}
.card{background:#fff;padding:16px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06);flex:1 1 360px;min-width:320px}
h3{margin-top:0;color:#006b57}
label{display:block;font-size:13px;color:#006b57;margin-bottom:6px}
input[type=text],input[type=email],input[type=password]{width:100%;padding:10px;border-radius:8px;border:1px solid #e6f3ee;background:#fbfffd;outline:none}
button{background:linear-gradient(180deg,var(--accent1),var(--accent2));color:#fff;border:none;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700}
.small{font-size:13px;padding:8px;background:#eef7f1;border-radius:8px;border:none;color:#006b57;cursor:pointer}
.hidden{display:none}
.kpi-row{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
.kpi{flex:1;background:linear-gradient(180deg,#fcfffd,#f0fff7);padding:10px;border-radius:8px;text-align:center}
.share-row{display:flex;gap:8px;margin-top:8px;align-items:center}
.terms-link{color:#00b87a;cursor:pointer;text-decoration:underline}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:9999}
.modal{width:94%;max-width:720px;background:#fff;border-radius:10px;padding:18px;box-shadow:0 10px 40px rgba(0,0,0,0.25);position:relative}
.modal .close{position:absolute;right:12px;top:12px;border:none;background:transparent;font-size:20px;cursor:pointer}
.terms-content{max-height:64vh;overflow:auto;padding-right:6px;color:#0c3b33}
#installBtn{background:#fff;color:#006b57;border-radius:8px;padding:8px 12px;border:1px solid #e6f3ee;cursor:pointer;font-weight:700;display:none}
#error{color:var(--danger)}
</style>
</head>
<body>
<div class="app" role="main">
  <header>
    <img id="appImage" src="https://via.placeholder.com/128.png?text=USDT" alt="USDT Miner logo"/>
    <div>
      <h1>USDT Miner</h1>
      <p class="muted">Invite friends, mine USDT, earn <strong>0.30 USDT</strong> per referral.</p>
    </div>
  </header>

  <div class="grid">
    <div class="card" id="authCard">
      <div id="registerBox">
        <h3>Create account</h3>
        <div class="field"><label>Username</label><input id="regUsername" type="text" autocomplete="username"></div>
        <div class="field"><label>Email</label><input id="regEmail" type="email" autocomplete="email"></div>
        <div class="field"><label>Password</label><input id="regPassword" type="password" autocomplete="new-password"></div>
        <div class="field"><label>Referral Code (optional)</label><input id="regRef" type="text"></div>
        <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
          <input id="agreeTC" type="checkbox"><label for="agreeTC" style="margin:0">I agree to the <span class="terms-link" id="openTC">Terms & Conditions</span></label>
        </div>
        <div style="display:flex;gap:10px;margin-top:12px">
          <button id="btnRegister">Create account</button>
          <button class="small" id="showLoginBtn">Have an account? Login</button>
        </div>
        <div id="regStatus" class="muted" style="margin-top:10px"></div>
      </div>

      <div id="loginBox" class="hidden">
        <h3>Login</h3>
        <div class="field"><label>Username or Email</label><input id="loginIdentifier" type="text" autocomplete="username"></div>
        <div class="field"><label>Password</label><input id="loginPass" type="password" autocomplete="current-password"></div>
        <div style="display:flex;gap:10px">
          <button id="btnLogin">Login</button>
          <button class="small" id="showRegisterBtn">Register</button>
        </div>
        <div id="loginStatus" class="muted" style="margin-top:10px"></div>
      </div>
    </div>

    <div class="card hidden" id="dashboard">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <h3>Your Referral Dashboard</h3>
        <div class="muted">Welcome, <span id="d_username_small"></span></div>
      </div>

      <div class="kpi-row">
        <div class="kpi"><h4>Invited</h4><p id="d_invited">0</p></div>
        <div class="kpi"><h4>Earnings</h4><p id="d_earnings">$0.00</p></div>
        <div class="kpi"><h4>Balance</h4><p id="d_balance">$0.00</p></div>
      </div>

      <div style="margin-top:12px">
        <div class="field"><label>Username</label><div id="d_username"></div></div>
        <div class="field"><label>Email</label><div id="d_email"></div></div>
        <div class="field"><label>Referral Code</label><div id="d_refcode"></div></div>
        <div class="field"><label>Your Referral Link</label><div id="d_link"></div></div>
        <div class="field"><label>Your Position</label><div id="d_position"></div></div>

        <div class="share-row">
          <button id="copyReferralBtn">Copy</button>
          <button class="small" id="shareReferralBtn">Share</button>
          <button id="installBtn" class="small">Install App</button>
          <button style="margin-left:auto;background:#ffdede;color:var(--danger)" id="logoutBtn" class="small">Logout</button>
        </div>

        <div id="error" style="margin-top:10px"></div>
      </div>
    </div>
  </div>

  <footer style="margin-top:16px">USDT Miner — demo (Firebase + FCM)</footer>
</div>

<!-- Terms modal -->
<div id="termsModal" class="modal-backdrop" style="display:none">
  <div class="modal" role="document">
    <button class="close" id="closeTC">✕</button>
    <div class="terms-content" tabindex="0">
      <h3>Terms & Conditions</h3>
      <p>Last updated: Oct 14, 2025</p>
      <p>By using USDT Miner you agree...</p>
      <h4>1. Eligibility</h4><p>18+ only.</p>
      <h4>2. Referral</h4><p>0.30 USDT per valid referral.</p>
    </div>
  </div>
</div>

<!-- Firebase libs -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-functions-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-messaging-compat.js"></script>

<script>
(async function(){
  // ---------- CONFIG ----------
  const firebaseConfig = {
    apiKey: "AIzaSyDR_rkTfGLWWX4NRWOVer9wwGlUFiRMRO4",
    authDomain: "usdt-login.firebaseapp.com",
    databaseURL: "https://usdt-login-default-rtdb.firebaseio.com",
    projectId: "usdt-login",
    storageBucket: "usdt-login.firebasestorage.app",
    messagingSenderId: "807602854227",
    appId: "1:807602854227:web:309ae73f572e48dbc7a9a6"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();
  const functions = firebase.functions();
  const messaging = firebase.messaging();

  // Disable persistence so user must re-login
  auth.setPersistence(firebase.auth.Auth.Persistence.NONE).catch(()=>{});

  // Helpers
  const $ = id => document.getElementById(id);
  function show(el){ el.classList.remove('hidden'); el.style.display=''; }
  function hide(el){ el.classList.add('hidden'); el.style.display='none'; }
  function isValidEmail(e){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e); }
  function genRefCode(username){ return username.trim().replace(/\s+/g,'').toUpperCase() + '-' + Math.floor(100+Math.random()*900); }

  // Terms modal wiring
  const termsModal = $('termsModal'), openTC = $('openTC'), closeTC = $('closeTC');
  openTC.addEventListener('click', e=>{ e.preventDefault(); termsModal.style.display='flex'; $('termsModal').setAttribute('aria-hidden','false'); $('termsModal').focus(); });
  closeTC.addEventListener('click', ()=>{ termsModal.style.display='none'; $('termsModal').setAttribute('aria-hidden','true'); });
  termsModal.addEventListener('click', e=>{ if(e.target === termsModal){ termsModal.style.display='none'; $('termsModal').setAttribute('aria-hidden','true'); } });
  document.addEventListener('keydown', e=>{ if(e.key==='Escape' && termsModal.style.display==='flex'){ termsModal.style.display='none'; } });

  // UI toggles
  $('showLoginBtn').addEventListener('click', ()=>{ $('registerBox').classList.add('hidden'); $('loginBox').classList.remove('hidden'); });
  $('showRegisterBtn').addEventListener('click', ()=>{ $('loginBox').classList.add('hidden'); $('registerBox').classList.remove('hidden'); });

  // PWA install prompt handling
  let deferredPrompt = null;
  const installBtn = $('installBtn');
  window.addEventListener('beforeinstallprompt', e=>{ e.preventDefault(); deferredPrompt = e; installBtn.style.display=''; });
  installBtn.addEventListener('click', async ()=>{ if(!deferredPrompt) return alert('Install not available'); deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; installBtn.style.display='none'; });

  // service worker (small)
  if('serviceWorker' in navigator){
    const swCode = `self.addEventListener('push', function(e){ const data = e.data && e.data.json ? e.data.json() : {}; const title = data.notification && data.notification.title || 'USDT Miner'; const options = { body: data.notification && data.notification.body || '', data: data.data || {} }; e.waitUntil(self.registration.showNotification(title, options)); });`;
    try{ const blob = new Blob([swCode], {type:'application/javascript'}); const swUrl = URL.createObjectURL(blob); navigator.serviceWorker.register(swUrl).catch(()=>{}); }catch(e){}
  }

  // VAPID PUBLIC KEY — REPLACE with your VAPID public key
  const VAPID_PUBLIC_KEY = 'YOUR_VAPID_PUBLIC_KEY_HERE';

  // Request FCM token & subscribe via callable
  async function requestFcmTokenAndSubscribe(uid){
    try{
      const perm = await Notification.requestPermission();
      if(perm !== 'granted') return;
      const token = await messaging.getToken({ vapidKey: VAPID_PUBLIC_KEY });
      if(!token) return console.warn('No FCM token obtained');
      await db.ref(`fcmTokens/${uid}/${token}`).set({ createdAt: Date.now() });
      // ask function to subscribe token to topic 'all' (server-side)
      try{
        const subscribeFn = functions.httpsCallable('subscribeTokenToTopic');
        await subscribeFn({ token, topic: 'all' });
      }catch(err){ console.warn('subscribeTokenToTopic failed', err); }
    }catch(err){ console.error('fcm err', err); }
  }

  // Register
  $('btnRegister').addEventListener('click', async ()=>{
    const username = $('regUsername').value.trim();
    const email = $('regEmail').value.trim().toLowerCase();
    const password = $('regPassword').value;
    const inviterCode = $('regRef').value.trim();
    const agreed = $('agreeTC').checked;
    $('regStatus').innerText = '';

    if(!username || !email || !password) { alert('Fill username, email, password'); return; }
    if(!isValidEmail(email)){ alert('Invalid email'); return; }
    if(!agreed){ alert('You must accept terms'); return; }

    try{
      $('regStatus').innerText = 'Creating account...';
      const uc = await auth.createUserWithEmailAndPassword(email, password);
      const uid = uc.user.uid;
      const refCode = genRefCode(username);
      const profile = { username, email, referralCode: refCode, balance: 0.30, referralEarnings:0, referrals:{}, createdAt:Date.now() };
      await db.ref('users/' + uid).set(profile);

      // try cloud function; fallback to client update
      let fnOk = false;
      if(inviterCode){
        try{
          const proc = functions.httpsCallable('processReferral');
          const res = await proc({ inviterCode, newUserUid: uid });
          if(res && res.data) fnOk = true;
        }catch(e){ console.warn('processReferral failed', e); }
      }
      if(inviterCode && !fnOk) await clientReferralFallback(inviterCode, uid, username);

      localStorage.setItem('currentUserUid', uid);
      await requestFcmTokenAndSubscribe(uid);
      $('regStatus').innerText = '';
      await loadDashboard(uid);
    }catch(err){
      console.error(err);
      $('regStatus').innerText = '';
      alert('Registration error: ' + (err.message || err));
    }
  });

  async function clientReferralFallback(inviterCode, newUserUid, newUsername){
    const usersSnap = await db.ref('users').once('value');
    const users = usersSnap.val() || {};
    let inviterKey = null, inviter = null;
    for(const k of Object.keys(users)){
      const u = users[k];
      if(u && u.referralCode === inviterCode){ inviterKey = k; inviter = u; break; }
    }
    if(!inviterKey) return;
    if(inviterKey === newUserUid) return;
    if(inviter.referrals && Object.values(inviter.referrals).includes(newUsername)) return;
    const updates = {};
    updates[`/users/${inviterKey}/referrals/${newUserUid}`] = newUsername;
    updates[`/users/${inviterKey}/referralEarnings`] = (inviter.referralEarnings || 0) + 0.30;
    updates[`/users/${inviterKey}/balance`] = (inviter.balance || 0) + 0.30;
    updates[`/users/${newUserUid}/balance`] = Math.max((users[newUserUid] && users[newUserUid].balance) || 0, 0.30);
    await db.ref().update(updates);
  }

  // Login
  $('btnLogin').addEventListener('click', async ()=>{
    const iden = $('loginIdentifier').value.trim();
    const pass = $('loginPass').value;
    if(!iden || !pass) return alert('Enter credentials');
    let emailToUse = iden;
    if(!iden.includes('@')){
      const snap = await db.ref('users').once('value');
      const users = snap.val() || {};
      let found = null;
      for(const k of Object.keys(users)){ if(users[k].username && users[k].username.toLowerCase()===iden.toLowerCase()){ found = users[k].email; break; } }
      if(!found) return alert('Username not found');
      emailToUse = found;
    }
    if(!isValidEmail(emailToUse)) return alert('Resolved email invalid');
    try{
      $('loginStatus').innerText = 'Signing in...';
      const uc = await auth.signInWithEmailAndPassword(emailToUse, pass);
      localStorage.setItem('currentUserUid', uc.user.uid);
      await requestFcmTokenAndSubscribe(uc.user.uid);
      $('loginStatus').innerText = '';
      await loadDashboard(uc.user.uid);
    }catch(err){
      console.error(err);
      $('loginStatus').innerText = '';
      if(err.code==='auth/wrong-password') alert('Incorrect password'); else alert('Login error: ' + (err.message || err));
    }
  });

  // sign out on leave so user must login again
  window.addEventListener('beforeunload', ()=>{ try{ auth.signOut(); }catch(e){} });

  // onAuth change
  auth.onAuthStateChanged(async user => { if(user) await loadDashboard(user.uid); else { $('authCard').classList.remove('hidden'); $('dashboard').classList.add('hidden'); } });

  async function loadDashboard(uid){
    try{
      const snap = await db.ref('users/' + uid).once('value');
      const me = snap.val(); if(!me) { alert('Profile not found'); return; }

      // compute ranking: sort users by number of referrals desc; positions start at 5783 + index
      const allSnap = await db.ref('users').once('value');
      const allUsers = allSnap.val() || {};
      const arr = Object.keys(allUsers).map(k => ({ uid:k, username: allUsers[k].username, invited: allUsers[k].referrals ? Object.keys(allUsers[k].referrals).length : 0 }));
      arr.sort((a,b)=>{ if(b.invited===a.invited) return (a.username||'').localeCompare(b.username||''); return b.invited - a.invited; });
      const idx = arr.findIndex(x=>x.uid===uid);
      const position = 5783 + (idx === -1 ? arr.length : idx);

      // show dashboard
      $('authCard').classList.add('hidden'); $('dashboard').classList.remove('hidden');

      $('d_username').innerText = me.username || '';
      $('d_username_small').innerText = me.username || '';
      $('d_email').innerText = me.email || '';
      $('d_refcode').innerText = me.referralCode || '';
      $('d_invited').innerText = me.referrals ? Object.keys(me.referrals).length : 0;
      $('d_earnings').innerText = '$' + Number(me.referralEarnings || 0).toFixed(2);
      $('d_balance').innerText = '$' + Number(me.balance || 0).toFixed(2);
      $('d_position').innerText = position + (position%10===1 && position%100!==11 ? 'st' : position%10===2 && position%100!==12 ? 'nd' : position%10===3 && position%100!==13 ? 'rd' : 'th');

      const link = `${location.origin}${location.pathname}?ref=${encodeURIComponent(me.referralCode)}`;
      $('d_link').innerText = link;
      localStorage.setItem('myReferralLink', link);

      // copy/share
      $('copyReferralBtn').onclick = async ()=>{ await navigator.clipboard.writeText(`${APP_META.title}\n\n${APP_META.description}\n\nJoin: ${link}`); alert('Referral copied'); };
      $('shareReferralBtn').onclick = async ()=>{ const shareData={title:APP_META.title,text:APP_META.description,url:link}; if(navigator.share) navigator.share(shareData).catch(()=>{}); else { await navigator.clipboard.writeText(`${APP_META.title}\n\n${APP_META.description}\n\n${link}`); alert('Copied'); } };

      $('logoutBtn').onclick = async ()=>{ await auth.signOut(); localStorage.removeItem('currentUserUid'); $('authCard').classList.remove('hidden'); $('dashboard').classList.add('hidden'); };

      // show install if available (handled via beforeinstallprompt elsewhere)
      // Install button wired earlier, visible only if event fired
    }catch(err){ console.error(err); $('error').innerText = 'Could not load dashboard: ' + (err.message || err); }
  }

  const APP_META = { title:'Earn USDT Daily with USDT Miner', description:'Start mining and earn USDT rewards by inviting friends.' };

})();
</script>
</body>
</html>
